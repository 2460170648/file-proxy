
# 文件代下载服务，github文件代下载

更多项目说明可以前往blog查看：[文件代下载服务说明](https://zwc365.com/2020/09/24/file-proxy-download)

项目使用地址：[https://pd.zwc365.com](https://pd.zwc365.com)

`CloudFlare 代下` 功能基于开源仓库修改：[hunshcn/gh-proxy](https://github.com/hunshcn/gh-proxy)

## 项目原理

对于一些资源文件，由于其服务器位于海外，下载速度可能很慢。本项目使用 CF 的 worker 功能，通过它进行了中转下载，理论上使用了 CloudFlare 的节点加速功能。

不使用加速功能时，下载一个资源文件的链路是：

```
本地 <===> 服务器
```

**当使用 Cloudflare 代下载服务时的链路是：**

```
本地 <===> CloudFlare <===> 服务器
```

**当使用本站代下功能，此时链路是：**

```
本地 <===> 我的服务器 <===> 服务器
```

此时的网速很大程度取决于你与 `CloudFlare` 或者 `本站服务器` 之间的连接速度。

对于一些在海外的资源文件，有明显的加速效果

### 本站服务器代下载运行方式

当使用本站服务器代下载时，其数据连接的方式如下：

1. 用户请求下载某个文件，提交任务到主节点
2. 主节点接收到任务后，缓存任务信息并重定向到一个子节点
3. 用户连接到这个子节点，请求下载这个任务
4. 子节点向主节点发起校验任务的请求
4. 子节点校验任务通过后，下载文件并返回给用户

## 特点

提供两种代下选择，`CloudFlare 代下` 基于 CloudFlare Workers。 `本站服务器代下` 则是使用服务器子节点下载

一般情况下，**推荐使用 `CloudFlare 代下功能` ，没有速度以及文件大小限制**

如果选择 **本站代下** 则限速 2M/s 且大小限制 1G。这个限制可能会有所调整

> 之所以本站代下有限制，是因为会消耗服务器带宽。如果服务量增多，对服务器压力很大

代下服务支持任意站点的下载直链。如：`zip` `tar.gz` `rar` `mp4` `apk` `iso` 等格式的下载文件

### 负载均衡

**最最最大的特点就是支持下载节点负载均衡了**

如果你会网页调试，应该能看到，下载服务使用了 `302` 重定向到真实的下载地址

如果你观察得足够仔细，会发现 `302` 重定向的域名可能每次都不相同。

这是因为本站会对发过来的请求，定向到后端下载地址，而这个后端可以配置多个，实现负载均衡。

> 理论上，配置的负载均衡后端地址越多越好。如果你想贡献后端，可以联系我增加。

> 如果后端下载地址返回病毒文件或者篡改的文件，这是没法识别和阻止的。所以如果收到投诉，会禁用掉被投诉的后端

> 现在这个网站刚起步。没什么访问量，所以暂时无压力

而且负载均衡节点可以很快速方便的添加。部署方式也极其简单。具体可以看后面的部署章节。不需要运行脚本及安装我提供的程序，也不需要 Docker

负载均衡支持设置权重。这个权重可由子节点自行设定。如果有人加入公益节点，可以根据自己服务器带宽自行设定权重

> 目前的负载均衡方式是后端根据权重随机分发下载节点
> 或许可以提供一个选项，在前端页面手动选择下载节点，但为了保持程序的小巧和简洁。可能不会新增这样的功能。

## 如何添加子节点

**添加子节点非常非常简单**，不需要安装我提供的软件，不需要运行部署脚本，不需要 docker。只要你的服务器有一个 web 应用即可

下面是使用 Nginx 作为子节点部署的教程，如果你连 Nginx 都没有安装，那么需要先安装 Nginx：

debian、Ubuntu 安装 Nginx
```
sudo apt update
sudo apt install nginx
```

CentOs 安装 Nginx
```
sudo yum update
sudo yum install Nginx
```

在安装完成后，路径 `/etc/nginx/conf.d` 目录下是所有的server配置文件

配置文件具体看项目中的 `gh-proxy.conf` 文件。可以将这个文件原样复制到 `/etc/nginx/conf.d` 目录中

整个配置文件中，需要修改的位置只有几项： `server_name ` 和 `ssl证书`

如果你连域名都没有，那么直接填写 ip 也可以。注意，如果你部署的网站没有 https ，可以删掉关于 https 那五行配置

然后使用 `nginx -s reload` 重载配置即可

如果你会修改 Nginx 配置，部分地方也是可以修改的，可以设置请求限制策略，也可以设置服务器权重。主节点会根据权重自动分发任务

当子节点部署完成后，可以留言，然后需要我手动加入到主节点的配置文件中。

**快来贡献你的闲置服务器吧**

> 作为下载服务器，带宽最好大于 10M 。且位于海外，例如香港或新加坡


